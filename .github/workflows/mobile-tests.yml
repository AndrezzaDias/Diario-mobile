name: Mobile Automation CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do projeto
        uses: actions/checkout@v4

      - name: Instalar Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Instalar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Instalar depend√™ncias Python
        run: pip install -r requirements.txt 

      - name: Instalar Appium 2 + UiAutomator2
        run: |
          npm install -g appium@2.11.2
          appium driver install uiautomator2@2.36.0

      - name: Configurar e Executar Testes no Emulador
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            echo "üöÄ Iniciando Appium em background..."
            appium --base-path /wd/hub --relaxed-security > appium.log 2>&1 &
            APPIUM_PID=$!
            echo "Appium PID: $APPIUM_PID"
            
            echo "‚è≥ Aguardando Appium iniciar (m√°ximo 60s)..."
            timeout 60s bash -c 'until curl -s http://127.0.0.1:4723/wd/hub/status > /dev/null 2>&1; do echo -n "."; sleep 2; done' || {
              echo "‚ùå Appium n√£o iniciou a tempo!"
              cat appium.log
              exit 1
            }
            echo ""
            echo "‚úÖ Appium est√° pronto!"
            
            echo "üì± Status do Appium:"
            curl -s http://127.0.0.1:4723/wd/hub/status | head -20
            
            echo ""
            echo "üîå Verificando dispositivo ADB..."
            adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
            adb devices
            
            echo "üì± Informa√ß√µes do dispositivo:"
            adb shell getprop ro.build.version.release
            adb shell getprop ro.product.cpu.abi
            
            echo ""
            echo "ü§ñ Executando testes Robot Framework..."
            robot --outputdir results test/ || TEST_EXIT_CODE=$?
            
            echo ""
            echo "üìã √öltimas linhas do log do Appium:"
            tail -50 appium.log
            
            # Parar Appium
            kill $APPIUM_PID 2>/dev/null || true
            
            # Retornar c√≥digo de sa√≠da dos testes
            exit ${TEST_EXIT_CODE:-0}

      - name: Upload Logs do Appium
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: appium-logs
          path: appium.log

      - name: Upload Relat√≥rios Robot Framework
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: robot-reports
          path: |
            results/log.html
            results/report.html
            results/output.xml
            results/screenshots/