name: Mobile Automation CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout do projeto
        uses: actions/checkout@v4

      - name: Instalar Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Instalar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Verificar versÃµes instaladas
        run: |
          echo "=== VersÃµes Instaladas ==="
          python --version
          java -version
          node --version
          npm --version
          echo "Android SDK: $ANDROID_HOME"

      - name: Instalar dependÃªncias Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Instalar Appium 2 + UiAutomator2
        run: |
          npm install -g appium@2.11.2
          appium driver install uiautomator2@2.36.0
          appium driver list

      - name: Verificar APK existe
        run: |
          if [ ! -f "app/DiarioMobile.apk" ]; then
            echo "âŒ ERRO: APK nÃ£o encontrado em app/DiarioMobile.apk"
            echo "ConteÃºdo do diretÃ³rio:"
            ls -la app/ || echo "DiretÃ³rio app/ nÃ£o existe!"
            exit 1
          else
            echo "âœ… APK encontrado"
            ls -lh app/DiarioMobile.apk
          fi

      - name: Habilitar KVM (performance do emulador)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Configurar e Executar Testes no Emulador
        uses: reactivecircus/android-emulator-runner@v2
        env:
          SHELL: /bin/bash
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: Nexus 6
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -skin 1080x1920
          disable-animations: true
          disk-size: 4096M
          heap-size: 512M
          ram-size: 4096M
          script: |
            set +e  # NÃ£o parar em erros para capturar logs
            
            echo "======================================"
            echo "Verificando ADB e Dispositivo"
            echo "======================================"
            
            # Reiniciar ADB server
            adb kill-server
            sleep 2
            adb start-server
            sleep 2
            
            # Aguardar device
            adb wait-for-device
            
            # Verificar dispositivos
            echo "Dispositivos conectados:"
            adb devices -l
            
            # Aguardar boot completo
            echo "Aguardando boot do emulador..."
            BOOT_COMPLETED=0
            for i in {1..60}; do
              BOOT_STATUS=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r\n')
              if [ "$BOOT_STATUS" == "1" ]; then
                echo "âœ… Boot completo!"
                BOOT_COMPLETED=1
                break
              fi
              echo "Tentativa $i/60 - Boot status: $BOOT_STATUS"
              sleep 3
            done
            
            if [ $BOOT_COMPLETED -eq 0 ]; then
              echo "âŒ ERRO: Emulador nÃ£o completou o boot!"
              exit 1
            fi
            
            # InformaÃ§Ãµes do device
            echo "=== Device Info ==="
            echo "Android Version: $(adb shell getprop ro.build.version.release)"
            echo "Device Model: $(adb shell getprop ro.product.model)"
            echo "Device ID: $(adb shell getprop ro.serialno)"
            
            # Desabilitar animaÃ§Ãµes
            adb shell settings put global window_animation_scale 0
            adb shell settings put global transition_animation_scale 0
            adb shell settings put global animator_duration_scale 0
            
            echo "======================================"
            echo "Iniciando Appium Server"
            echo "======================================"
            
            # Criar diretÃ³rio de logs
            mkdir -p logs
            
            # Iniciar Appium
            appium --base-path /wd/hub \
                   --relaxed-security \
                   --log logs/appium.log \
                   --log-level debug \
                   --allow-insecure chromedriver_autodownload > /dev/null 2>&1 &
            
            APPIUM_PID=$!
            echo "Appium PID: $APPIUM_PID"
            
            # Aguardar Appium iniciar
            echo "Aguardando Appium iniciar..."
            APPIUM_READY=0
            for i in {1..30}; do
              if curl -s http://127.0.0.1:4723/wd/hub/status > /dev/null 2>&1; then
                echo "âœ… Appium iniciou!"
                APPIUM_READY=1
                break
              fi
              echo "Tentativa $i/30..."
              sleep 2
            done
            
            if [ $APPIUM_READY -eq 0 ]; then
              echo "âŒ ERRO: Appium nÃ£o iniciou!"
              echo "=== Log do Appium ==="
              cat logs/appium.log 2>/dev/null || echo "Log nÃ£o disponÃ­vel"
              exit 1
            fi
            
            # Status do Appium
            echo "=== Appium Status ==="
            curl -s http://127.0.0.1:4723/wd/hub/status | python3 -m json.tool || echo "NÃ£o foi possÃ­vel obter status"
            
            echo "======================================"
            echo "Executando Testes Robot Framework"
            echo "======================================"
            
            # Criar diretÃ³rio de resultados
            mkdir -p results
            
            # Executar testes
            robot \
              --outputdir results \
              --loglevel DEBUG \
              --consolewidth 120 \
              --variable PLATFORM_NAME:Android \
              --variable DEVICE_NAME:emulator-5554 \
              --variable APPIUM_SERVER:http://127.0.0.1:4723 \
              test/ || TEST_FAILED=1
            
            echo "======================================"
            echo "Finalizando"
            echo "======================================"
            
            # Copiar logs
            cp logs/appium.log . 2>/dev/null || echo "Log do Appium nÃ£o encontrado"
            
            # Listar arquivos gerados
            echo "=== Arquivos gerados ==="
            ls -lh results/ 2>/dev/null || echo "Nenhum resultado gerado"
            ls -lh *.log 2>/dev/null || echo "Nenhum log gerado"
            
            # Mostrar Ãºltimas linhas do log em caso de falha
            if [ ! -z "$TEST_FAILED" ]; then
              echo "âŒ Testes falharam! Ãšltimas 100 linhas do Appium:"
              tail -n 100 appium.log 2>/dev/null || echo "Log nÃ£o disponÃ­vel"
            fi
            
            # Matar Appium
            kill $APPIUM_PID 2>/dev/null || true
            
            # Retornar cÃ³digo de saÃ­da
            if [ ! -z "$TEST_FAILED" ]; then
              exit 1
            fi
            
            exit 0

      - name: Upload Logs do Appium
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: appium-logs
          path: |
            appium.log
            logs/
          retention-days: 7
          if-no-files-found: warn

      - name: Upload RelatÃ³rios Robot Framework
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: robot-reports
          path: |
            results/log.html
            results/report.html
            results/output.xml
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: results/screenshots/
          retention-days: 30
          if-no-files-found: ignore

      - name: Publicar Resultado dos Testes
        if: always() && hashFiles('results/output.xml') != ''
        uses: EnricoMi/publish-unit-test-result-action@v2
        continue-on-error: true
        with:
          files: results/output.xml
          check_name: "Robot Framework Test Results"
          comment_mode: off

      - name: Resumo dos Testes
        if: always()
        run: |
          echo "## ðŸ“Š Resultado dos Testes" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "results/output.xml" ]; then
            echo "âœ… Testes executados com sucesso!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“„ Verifique os artifacts para ver os relatÃ³rios completos:" >> $GITHUB_STEP_SUMMARY
            echo "- robot-reports" >> $GITHUB_STEP_SUMMARY
            echo "- screenshots" >> $GITHUB_STEP_SUMMARY
            echo "- appium-logs" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Testes nÃ£o foram executados ou falharam antes de gerar resultados" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” Verifique os logs nos artifacts:" >> $GITHUB_STEP_SUMMARY
            echo "- appium-logs" >> $GITHUB_STEP_SUMMARY
          fi